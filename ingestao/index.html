<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    
    
    <link rel="shortcut icon" href="../img/favicon.ico">

    
    <title>Ingestão e Processamento de Dados (Framework de testes e qualidade) - Módulo 11 ES</title>
    

    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.12.0/css/all.css">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.12.0/css/v4-shims.css">
    <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/hack-font@3.3.0/build/web/hack.min.css">
    <link href='//rsms.me/inter/inter.css' rel='stylesheet' type='text/css'>
    <link href='//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,700italic,400,300,600,700&subset=latin-ext,latin' rel='stylesheet' type='text/css'>
    <link href="../css/bootstrap-custom.min.css" rel="stylesheet">
    <link href="../css/base.min.css" rel="stylesheet">
    <link href="../css/cinder.min.css" rel="stylesheet">

    
        
        <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.18.0/build/styles/github.min.css">
        
    

    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
            <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
            <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
        <![endif]-->

    

     
</head>

<body>

    <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            

            <!-- Main title -->

            
              <a class="navbar-brand" href="..">Módulo 11 ES</a>
            
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
                <!-- Main navigation -->
                <ul class="nav navbar-nav">
                
                
                    <li >
                        <a href="..">Home</a>
                    </li>
                
                
                
                    <li class="dropdown active">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Aulas <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            
<li >
    <a href="../datasourcing/">Data Sourcing e Data Analysis com R Studio</a>
</li>

                        
                            
<li >
    <a href="../arquitetura1/">Arquitetura e Governança de Dados na Nuvem 1</a>
</li>

                        
                            
<li >
    <a href="../arquitetura2/">Arquitetura e Governança de Dados na Nuvem 2</a>
</li>

                        
                            
<li class="active">
    <a href="./">Ingestão e Processamento de Dados (Framework de testes e qualidade)</a>
</li>

                        
                            
<li >
    <a href="../seguranca/">Segurança e Governança de Dados (LGPD)</a>
</li>

                        
                            
<li >
    <a href="../precificacao/">Precificação em Nuvem</a>
</li>

                        
                            
<li >
    <a href="../metricas/">Métricas, Telemetria e Gestão de Microserviços</a>
</li>

                        
                            
<li >
    <a href="../datalakes/">Data Lakes e Data Warehouses</a>
</li>

                        
                            
<li >
    <a href="../etl/">Serviços e ETLs para Transformação de Dados e Processamento de Dados em Escala (train at scale)</a>
</li>

                        
                            
<li >
    <a href="../processamento/">Processamento de Dados na Nuvem</a>
</li>

                        
                            
<li >
    <a href="../mlops/">Ciclo de Vida e Automatização de Pipeline de Dados (MLOps)</a>
</li>

                        
                            
<li >
    <a href="../predicao/">Processamento e Predição em Produção</a>
</li>

                        
                            
<li >
    <a href="../ui_dashboards/">User Interface e Dashboards</a>
</li>

                        
                            
<li >
    <a href="../datastorytelling/">Data Storytelling</a>
</li>

                        
                        </ul>
                    </li>
                
                
                </ul>

            <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                            <i class="fas fa-search"></i> Search
                        </a>
                    </li>
                    <li >
                        <a rel="prev" href="../arquitetura2/">
                            <i class="fas fa-arrow-left"></i> Previous
                        </a>
                    </li>
                    <li >
                        <a rel="next" href="../seguranca/">
                            Next <i class="fas fa-arrow-right"></i>
                        </a>
                    </li>
            </ul>
        </div>
    </div>
</div>

    <div class="container">
        
        
        <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
        <li class="first-level active"><a href="#ingestao-e-processamento-de-dados">Ingestão e Processamento de Dados</a></li>
        <li class="first-level "><a href="#agenda">Agenda</a></li>
        <li class="first-level "><a href="#demonstracao-pratica-de-um-pacote-python">Demonstração Prática de Um Pacote Python</a></li>
            <li class="second-level"><a href="#pre-requisitos">Pré-requisitos</a></li>
                
                <li class="third-level"><a href="#criando-o-pacote">Criando o Pacote</a></li>
                <li class="third-level"><a href="#pyprojecttoml">Pyproject.toml</a></li>
                <li class="third-level"><a href="#configurar-o-docker-compose-com-minio-e-clickhouse">Configurar o Docker Compose com MinIO e ClickHouse</a></li>
            <li class="second-level"><a href="#vamos-testar-o-miniio">Vamos testar o Mini.IO</a></li>
                
            <li class="second-level"><a href="#sql-para-cracao-da-tabela">SQL para cração da tabela!</a></li>
                
            <li class="second-level"><a href="#aplicativo-pipe-de-dados">Aplicativo Pipe de Dados</a></li>
                
            <li class="second-level"><a href="#vamos-testar-com-requestshttp">Vamos testar com requests.http</a></li>
                
            <li class="second-level"><a href="#agora-criamos-a-view">Agora criamos a VIEW:</a></li>
                
            <li class="second-level"><a href="#este-e-um-pacote-de-demonstracao-seu-grupo-pode-e-deve-criar-uma-arquitetura-propria-com-testes">Este é um pacote de demonstração: seu grupo pode e deve criar uma arquitetura própria com Testes!</a></li>
                
        <li class="first-level "><a href="#tarefa">Tarefa</a></li>
    </ul>
</div></div>
        <div class="col-md-9" role="main">

<h1 id="ingestao-e-processamento-de-dados">Ingestão e Processamento de Dados<a class="headerlink" href="#ingestao-e-processamento-de-dados" title="Permanent link">&para;</a></h1>
<p style="text-align: justify;">Esta instrução foca em estratégias e metodologias essenciais para a ingestão de dados em plataformas analíticas. Discutiremos as melhores práticas para a coleta eficiente de dados de diversas fontes, a importância de pipelines de dados confiáveis e como otimizar a ingestão para análises em tempo real. Os alunos aprenderão sobre as tecnologias e ferramentas atuais que facilitam o processo de ingestão, garantindo a qualidade e a disponibilidade dos dados para processamento subsequente e análise. Serão feitos scripts com testes integrados.</p>

<table>
<thead>
<tr>
<th>Autoestudo</th>
<th>Link</th>
<th>Pontuação</th>
</tr>
</thead>
<tbody>
<tr>
<td>Pacote de Ingestão de Dados</td>
<td><a href="https://colab.research.google.com/drive/1LJDhsksOxlcf6srx7QIsHAGxu1hGJe5m?usp=sharing">Acesse</a></td>
<td>3 pontos</td>
</tr>
<tr>
<td>Consultas complexas em SQL</td>
<td><a href="https://integrada.minhabiblioteca.com.br/reader/books/9786556900186/pageid/118">Acesse</a></td>
<td>0 pontos</td>
</tr>
</tbody>
</table>
<h1 id="agenda">Agenda<a class="headerlink" href="#agenda" title="Permanent link">&para;</a></h1>
<table>
<thead>
<tr>
<th>Atividade</th>
<th>Tempo</th>
</tr>
</thead>
<tbody>
<tr>
<td>Demonstração Prática do Pacote de Ingestão</td>
<td>60m</td>
</tr>
<tr>
<td>Ponderada em Sala de Aula</td>
<td>60m</td>
</tr>
</tbody>
</table>
<h1 id="demonstracao-pratica-de-um-pacote-python">Demonstração Prática de Um Pacote Python<a class="headerlink" href="#demonstracao-pratica-de-um-pacote-python" title="Permanent link">&para;</a></h1>
<h2 id="pre-requisitos">Pré-requisitos<a class="headerlink" href="#pre-requisitos" title="Permanent link">&para;</a></h2>
<ul>
<li>Conhecimento básico em Python e Docker.</li>
<li>Instalação do Docker e Docker Compose.</li>
<li>Instalação do Poetry.</li>
</ul>
<h3 id="criando-o-pacote">Criando o Pacote<a class="headerlink" href="#criando-o-pacote" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span><code>poetry<span class="w"> </span>new<span class="w"> </span>data_pipeline
</code></pre></div>

<h3 id="pyprojecttoml">Pyproject.toml<a class="headerlink" href="#pyprojecttoml" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span><code><span class="nb">cd</span><span class="w"> </span>data_pipeline
poetry<span class="w"> </span>add<span class="w"> </span>flask<span class="w"> </span>requests<span class="w"> </span>pandas<span class="w"> </span>pyarrow<span class="w"> </span>minio<span class="w"> </span>clickhouse-connect<span class="w"> </span>python-dotenv
</code></pre></div>

<h3 id="configurar-o-docker-compose-com-minio-e-clickhouse">Configurar o Docker Compose com MinIO e ClickHouse<a class="headerlink" href="#configurar-o-docker-compose-com-minio-e-clickhouse" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span><code><span class="n">version</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;3.8&#39;</span>

<span class="n">services</span><span class="p">:</span>
<span class="w">  </span><span class="n">minio</span><span class="p">:</span>
<span class="w">    </span><span class="n">image</span><span class="p">:</span><span class="w"> </span><span class="n">minio</span><span class="o">/</span><span class="n">minio</span><span class="p">:</span><span class="n">latest</span>
<span class="w">    </span><span class="n">container_name</span><span class="p">:</span><span class="w"> </span><span class="n">minio</span>
<span class="w">    </span><span class="n">ports</span><span class="p">:</span>
<span class="w">      </span><span class="o">-</span><span class="w"> </span><span class="s2">&quot;9000:9000&quot;</span><span class="w">   </span><span class="c1"># Porta para a API</span>
<span class="w">      </span><span class="o">-</span><span class="w"> </span><span class="s2">&quot;9001:9001&quot;</span><span class="w">   </span><span class="c1"># Porta para a Web UI</span>
<span class="w">    </span><span class="n">environment</span><span class="p">:</span>
<span class="w">      </span><span class="n">MINIO_ROOT_USER</span><span class="p">:</span><span class="w"> </span><span class="n">minioadmin</span>
<span class="w">      </span><span class="n">MINIO_ROOT_PASSWORD</span><span class="p">:</span><span class="w"> </span><span class="n">minioadmin</span>
<span class="w">    </span><span class="n">volumes</span><span class="p">:</span>
<span class="w">      </span><span class="o">-</span><span class="w"> </span><span class="n">minio_data</span><span class="p">:</span><span class="o">/</span><span class="n">data</span><span class="w">  </span><span class="c1"># Persistência de dados</span>
<span class="w">    </span><span class="n">command</span><span class="p">:</span><span class="w"> </span><span class="n">server</span><span class="w"> </span><span class="o">/</span><span class="n">data</span><span class="w"> </span><span class="o">--</span><span class="n">console</span><span class="o">-</span><span class="n">address</span><span class="w"> </span><span class="s2">&quot;:9001&quot;</span>
<span class="w">    </span><span class="n">restart</span><span class="p">:</span><span class="w"> </span><span class="n">always</span>

<span class="w">  </span><span class="n">clickhouse</span><span class="p">:</span>
<span class="w">    </span><span class="n">image</span><span class="p">:</span><span class="w"> </span><span class="n">yandex</span><span class="o">/</span><span class="n">clickhouse</span><span class="o">-</span><span class="n">server</span><span class="p">:</span><span class="n">latest</span>
<span class="w">    </span><span class="n">container_name</span><span class="p">:</span><span class="w"> </span><span class="n">clickhouse</span>
<span class="w">    </span><span class="n">ports</span><span class="p">:</span>
<span class="w">      </span><span class="o">-</span><span class="w"> </span><span class="s2">&quot;8123:8123&quot;</span><span class="w">  </span><span class="c1"># Porta para a HTTP interface</span>
<span class="w">    </span><span class="n">volumes</span><span class="p">:</span>
<span class="w">      </span><span class="o">-</span><span class="w"> </span><span class="n">clickhouse_data</span><span class="p">:</span><span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">clickhouse</span><span class="w">  </span><span class="c1"># Persistência de dados</span>
<span class="w">    </span><span class="n">restart</span><span class="p">:</span><span class="w"> </span><span class="n">always</span>

<span class="n">volumes</span><span class="p">:</span>
<span class="w">  </span><span class="n">minio_data</span><span class="p">:</span>
<span class="w">    </span><span class="n">driver</span><span class="p">:</span><span class="w"> </span><span class="n">local</span>
<span class="w">  </span><span class="n">clickhouse_data</span><span class="p">:</span>
<span class="w">    </span><span class="n">driver</span><span class="p">:</span><span class="w"> </span><span class="n">local</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code>docker-compose<span class="w"> </span>up<span class="w"> </span>--build
</code></pre></div>

<h2 id="vamos-testar-o-miniio">Vamos testar o Mini.IO<a class="headerlink" href="#vamos-testar-o-miniio" title="Permanent link">&para;</a></h2>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span> <span class="nn">minio</span> <span class="kn">import</span> <span class="n">Minio</span>
<span class="kn">from</span> <span class="nn">minio.error</span> <span class="kn">import</span> <span class="n">S3Error</span>

<span class="k">def</span> <span class="nf">test_minio</span><span class="p">():</span>
    <span class="c1"># Configuração do cliente MinIO</span>
    <span class="n">client</span> <span class="o">=</span> <span class="n">Minio</span><span class="p">(</span>
        <span class="s2">&quot;localhost:9000&quot;</span><span class="p">,</span>  <span class="c1"># Endereço do MinIO</span>
        <span class="n">access_key</span><span class="o">=</span><span class="s2">&quot;minioadmin&quot;</span><span class="p">,</span>  <span class="c1"># Chave de acesso</span>
        <span class="n">secret_key</span><span class="o">=</span><span class="s2">&quot;minioadmin&quot;</span><span class="p">,</span>  <span class="c1"># Chave secreta</span>
        <span class="n">secure</span><span class="o">=</span><span class="kc">False</span>  <span class="c1"># Use True se estiver usando HTTPS</span>
    <span class="p">)</span>

    <span class="n">bucket_name</span> <span class="o">=</span> <span class="s2">&quot;test-bucket&quot;</span>
    <span class="n">object_name</span> <span class="o">=</span> <span class="s2">&quot;test.txt&quot;</span>
    <span class="n">file_content</span> <span class="o">=</span> <span class="s2">&quot;Este é um arquivo de teste.&quot;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Criar bucket se não existir</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">client</span><span class="o">.</span><span class="n">bucket_exists</span><span class="p">(</span><span class="n">bucket_name</span><span class="p">):</span>
            <span class="n">client</span><span class="o">.</span><span class="n">make_bucket</span><span class="p">(</span><span class="n">bucket_name</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Bucket &#39;</span><span class="si">{</span><span class="n">bucket_name</span><span class="si">}</span><span class="s2">&#39; criado com sucesso.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Bucket &#39;</span><span class="si">{</span><span class="n">bucket_name</span><span class="si">}</span><span class="s2">&#39; já existe.&quot;</span><span class="p">)</span>

        <span class="c1"># Criar um arquivo de teste</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">object_name</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">file_content</span><span class="p">)</span>

        <span class="c1"># Fazer upload do arquivo para o MinIO</span>
        <span class="n">client</span><span class="o">.</span><span class="n">fput_object</span><span class="p">(</span><span class="n">bucket_name</span><span class="p">,</span> <span class="n">object_name</span><span class="p">,</span> <span class="n">object_name</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Arquivo &#39;</span><span class="si">{</span><span class="n">object_name</span><span class="si">}</span><span class="s2">&#39; enviado com sucesso para o bucket &#39;</span><span class="si">{</span><span class="n">bucket_name</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>

        <span class="c1"># Fazer download do arquivo do MinIO</span>
        <span class="n">client</span><span class="o">.</span><span class="n">fget_object</span><span class="p">(</span><span class="n">bucket_name</span><span class="p">,</span> <span class="n">object_name</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;downloaded_</span><span class="si">{</span><span class="n">object_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Arquivo &#39;</span><span class="si">{</span><span class="n">object_name</span><span class="si">}</span><span class="s2">&#39; baixado com sucesso do bucket &#39;</span><span class="si">{</span><span class="n">bucket_name</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>

        <span class="c1"># Ler o conteúdo do arquivo baixado</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;downloaded_</span><span class="si">{</span><span class="n">object_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="n">downloaded_content</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Conteúdo do arquivo baixado: </span><span class="si">{</span><span class="n">downloaded_content</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">except</span> <span class="n">S3Error</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Erro ao interagir com o MinIO: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">test_minio</span><span class="p">()</span>
</code></pre></div>

<h2 id="sql-para-cracao-da-tabela">SQL para cração da tabela!<a class="headerlink" href="#sql-para-cracao-da-tabela" title="Permanent link">&para;</a></h2>
<p>Crie uma pasta <code>sql/</code> e o arquivo <code>create_table.sql</code> com o código:</p>
<div class="codehilite"><pre><span></span><code><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="k">IF</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">EXISTS</span><span class="w"> </span><span class="n">working_data</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">data_ingestao</span><span class="w"> </span><span class="n">DateTime</span><span class="p">,</span>
<span class="w">    </span><span class="n">dado_linha</span><span class="w"> </span><span class="n">String</span><span class="p">,</span>
<span class="w">    </span><span class="n">tag</span><span class="w"> </span><span class="n">String</span>
<span class="p">)</span><span class="w"> </span><span class="n">ENGINE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MergeTree</span><span class="p">()</span>
<span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">data_ingestao</span><span class="p">;</span>
</code></pre></div>

<h2 id="aplicativo-pipe-de-dados">Aplicativo Pipe de Dados<a class="headerlink" href="#aplicativo-pipe-de-dados" title="Permanent link">&para;</a></h2>
<p>Dentro da pasta <code>data_pipeline</code> crie os arquivos:</p>
<p><code>clickhouse_client.py</code></p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="nn">clickhouse_connect</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">dotenv</span> <span class="kn">import</span> <span class="n">load_dotenv</span>

<span class="n">load_dotenv</span><span class="p">()</span>

<span class="c1"># Configuração do cliente ClickHouse</span>
<span class="n">CLICKHOUSE_HOST</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;CLICKHOUSE_HOST&#39;</span><span class="p">)</span>
<span class="n">CLICKHOUSE_PORT</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;CLICKHOUSE_PORT&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">get_client</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">clickhouse_connect</span><span class="o">.</span><span class="n">get_client</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="n">CLICKHOUSE_HOST</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="n">CLICKHOUSE_PORT</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">execute_sql_script</span><span class="p">(</span><span class="n">script_path</span><span class="p">):</span>
    <span class="n">client</span> <span class="o">=</span> <span class="n">get_client</span><span class="p">()</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">script_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
        <span class="n">sql_script</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="n">client</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="n">sql_script</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">client</span>

<span class="k">def</span> <span class="nf">insert_dataframe</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">table_name</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span>
    <span class="n">client</span><span class="o">.</span><span class="n">insert_df</span><span class="p">(</span><span class="n">table_name</span><span class="p">,</span> <span class="n">df</span><span class="p">)</span>
</code></pre></div>

<p><code>data_processing.py</code></p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">pyarrow</span> <span class="k">as</span> <span class="nn">pa</span>
<span class="kn">import</span> <span class="nn">pyarrow.parquet</span> <span class="k">as</span> <span class="nn">pq</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>

<span class="k">def</span> <span class="nf">process_data</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="c1"># Criar DataFrame e salvar como Parquet</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">data</span><span class="p">])</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;raw_data_</span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">%H%M%S&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">.parquet&quot;</span>
    <span class="n">table</span> <span class="o">=</span> <span class="n">pa</span><span class="o">.</span><span class="n">Table</span><span class="o">.</span><span class="n">from_pandas</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
    <span class="n">pq</span><span class="o">.</span><span class="n">write_table</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">filename</span>

<span class="k">def</span> <span class="nf">prepare_dataframe_for_insert</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;data_ingestao&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;dado_linha&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">row</span><span class="o">.</span><span class="n">to_json</span><span class="p">(),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;tag&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;example_tag&#39;</span>
    <span class="k">return</span> <span class="n">df</span><span class="p">[[</span><span class="s1">&#39;data_ingestao&#39;</span><span class="p">,</span> <span class="s1">&#39;dado_linha&#39;</span><span class="p">,</span> <span class="s1">&#39;tag&#39;</span><span class="p">]]</span>
</code></pre></div>

<p><code>minio_client.py</code></p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span> <span class="nn">minio</span> <span class="kn">import</span> <span class="n">Minio</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">dotenv</span> <span class="kn">import</span> <span class="n">load_dotenv</span>

<span class="n">load_dotenv</span><span class="p">()</span>

<span class="c1"># Carregar variáveis de ambiente</span>
<span class="n">MINIO_ENDPOINT</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;MINIO_ENDPOINT&#39;</span><span class="p">)</span>
<span class="n">MINIO_ACCESS_KEY</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;MINIO_ACCESS_KEY&#39;</span><span class="p">)</span>
<span class="n">MINIO_SECRET_KEY</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;MINIO_SECRET_KEY&#39;</span><span class="p">)</span>

<span class="c1"># Configuração do cliente MinIO</span>
<span class="n">minio_client</span> <span class="o">=</span> <span class="n">Minio</span><span class="p">(</span>
    <span class="n">MINIO_ENDPOINT</span><span class="p">,</span>
    <span class="n">access_key</span><span class="o">=</span><span class="n">MINIO_ACCESS_KEY</span><span class="p">,</span>
    <span class="n">secret_key</span><span class="o">=</span><span class="n">MINIO_SECRET_KEY</span><span class="p">,</span>
    <span class="n">secure</span><span class="o">=</span><span class="kc">False</span>
<span class="p">)</span>

<span class="k">def</span> <span class="nf">create_bucket_if_not_exists</span><span class="p">(</span><span class="n">bucket_name</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">minio_client</span><span class="o">.</span><span class="n">bucket_exists</span><span class="p">(</span><span class="n">bucket_name</span><span class="p">):</span>
        <span class="n">minio_client</span><span class="o">.</span><span class="n">make_bucket</span><span class="p">(</span><span class="n">bucket_name</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">upload_file</span><span class="p">(</span><span class="n">bucket_name</span><span class="p">,</span> <span class="n">file_path</span><span class="p">):</span>
    <span class="n">file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
    <span class="n">minio_client</span><span class="o">.</span><span class="n">fput_object</span><span class="p">(</span><span class="n">bucket_name</span><span class="p">,</span> <span class="n">file_name</span><span class="p">,</span> <span class="n">file_path</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">download_file</span><span class="p">(</span><span class="n">bucket_name</span><span class="p">,</span> <span class="n">file_name</span><span class="p">,</span> <span class="n">local_file_path</span><span class="p">):</span>
    <span class="n">minio_client</span><span class="o">.</span><span class="n">fget_object</span><span class="p">(</span><span class="n">bucket_name</span><span class="p">,</span> <span class="n">file_name</span><span class="p">,</span> <span class="n">local_file_path</span><span class="p">)</span>
</code></pre></div>

<p>e na pasta raiz o <code>app.py</code></p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">jsonify</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">data_pipeline.minio_client</span> <span class="kn">import</span> <span class="n">create_bucket_if_not_exists</span><span class="p">,</span> <span class="n">upload_file</span><span class="p">,</span> <span class="n">download_file</span>
<span class="kn">from</span> <span class="nn">data_pipeline.clickhouse_client</span> <span class="kn">import</span> <span class="n">execute_sql_script</span><span class="p">,</span> <span class="n">get_client</span><span class="p">,</span> <span class="n">insert_dataframe</span>
<span class="kn">from</span> <span class="nn">data_pipeline.data_processing</span> <span class="kn">import</span> <span class="n">process_data</span><span class="p">,</span> <span class="n">prepare_dataframe_for_insert</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="c1"># Criar bucket se não existir</span>
<span class="n">create_bucket_if_not_exists</span><span class="p">(</span><span class="s2">&quot;raw-data&quot;</span><span class="p">)</span>

<span class="c1"># Executar o script SQL para criar a tabela</span>
<span class="n">execute_sql_script</span><span class="p">(</span><span class="s1">&#39;sql/create_table.sql&#39;</span><span class="p">)</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/data&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">receive_data</span><span class="p">():</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">get_json</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span> <span class="ow">or</span> <span class="s1">&#39;date&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">data</span> <span class="ow">or</span> <span class="s1">&#39;dados&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Formato de dados inválido&quot;</span><span class="p">}),</span> <span class="mi">400</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">])</span>
        <span class="nb">int</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;dados&#39;</span><span class="p">])</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Tipo de dados inválido&quot;</span><span class="p">}),</span> <span class="mi">400</span>

    <span class="c1"># Processar e salvar dados</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="n">process_data</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">upload_file</span><span class="p">(</span><span class="s2">&quot;raw-data&quot;</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>

    <span class="c1"># Ler arquivo Parquet do MinIO</span>
    <span class="n">download_file</span><span class="p">(</span><span class="s2">&quot;raw-data&quot;</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;downloaded_</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">df_parquet</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;downloaded_</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Preparar e inserir dados no ClickHouse</span>
    <span class="n">df_prepared</span> <span class="o">=</span> <span class="n">prepare_dataframe_for_insert</span><span class="p">(</span><span class="n">df_parquet</span><span class="p">)</span>
    <span class="n">client</span> <span class="o">=</span> <span class="n">get_client</span><span class="p">()</span>  <span class="c1"># Obter o cliente ClickHouse</span>
    <span class="n">insert_dataframe</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="s1">&#39;working_data&#39;</span><span class="p">,</span> <span class="n">df_prepared</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Dados recebidos, armazenados e processados com sucesso&quot;</span><span class="p">}),</span> <span class="mi">200</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s1">&#39;0.0.0.0&#39;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">5000</span><span class="p">)</span>
</code></pre></div>

<p>e o <code>.env</code></p>
<div class="codehilite"><pre><span></span><code>MINIO_ENDPOINT=localhost:9000
MINIO_ACCESS_KEY=minioadmin
MINIO_SECRET_KEY=minioadmin

CLICKHOUSE_HOST=localhost
CLICKHOUSE_PORT=8123
</code></pre></div>

<h2 id="vamos-testar-com-requestshttp">Vamos testar com requests.http<a class="headerlink" href="#vamos-testar-com-requestshttp" title="Permanent link">&para;</a></h2>
<div class="codehilite"><pre><span></span><code><span class="err">POST http://localhost:5000/data</span>
<span class="err">Content-Type: application/json</span>

<span class="err">{</span>
<span class="err">    &quot;date&quot;: 1692345600,</span>
<span class="err">    &quot;dados&quot;: 12345</span>
<span class="err">}</span>
</code></pre></div>

<h2 id="agora-criamos-a-view">Agora criamos a VIEW:<a class="headerlink" href="#agora-criamos-a-view" title="Permanent link">&para;</a></h2>
<div class="codehilite"><pre><span></span><code><span class="k">CREATE</span><span class="w"> </span><span class="k">VIEW</span><span class="w"> </span><span class="k">IF</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">EXISTS</span><span class="w"> </span><span class="n">working_data_view</span><span class="w"> </span><span class="k">AS</span>
<span class="k">SELECT</span>
<span class="w">    </span><span class="n">data_ingestao</span><span class="p">,</span>
<span class="w">    </span><span class="n">JSONExtractInt</span><span class="p">(</span><span class="n">dado_linha</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;date&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">date_unix</span><span class="p">,</span>
<span class="w">    </span><span class="n">JSONExtractInt</span><span class="p">(</span><span class="n">dado_linha</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;dados&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">dados</span><span class="p">,</span>
<span class="w">    </span><span class="n">toDateTime</span><span class="p">(</span><span class="n">JSONExtractInt</span><span class="p">(</span><span class="n">dado_linha</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;data_ingestao&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">1000</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">data_ingestao_datetime</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">working_data</span><span class="p">;</span>
</code></pre></div>

<h2 id="este-e-um-pacote-de-demonstracao-seu-grupo-pode-e-deve-criar-uma-arquitetura-propria-com-testes">Este é um pacote de demonstração: seu grupo pode e deve criar uma arquitetura própria com Testes!<a class="headerlink" href="#este-e-um-pacote-de-demonstracao-seu-grupo-pode-e-deve-criar-uma-arquitetura-propria-com-testes" title="Permanent link">&para;</a></h2>
<h1 id="tarefa">Tarefa<a class="headerlink" href="#tarefa" title="Permanent link">&para;</a></h1>
<p><strong>Fazer em sala de aula a Ponderada!</strong></p></div>
        
        
    </div>

    
      <footer class="col-md-12 text-center">
          
          
            <hr>
            <p>
            <small>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a>.</small>
            </p>
          

          
          
      </footer>
    
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <script src="../js/bootstrap-3.0.3.min.js"></script>

    
    <script src="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.18.0/build/highlight.min.js"></script>
        
    <script>hljs.initHighlightingOnLoad();</script>
    

    <script>var base_url = ".."</script>
    
    <script src="../js/base.js"></script>
    <script src="../search/main.js"></script>

    <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">
                    <span aria-hidden="true">&times;</span>
                    <span class="sr-only">Close</span>
                </button>
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form>
                    <div class="form-group">
                        <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>
    </body>

</html>
